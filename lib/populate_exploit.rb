require 'csv'
require 'open3'

# PopulateExploit.populate_exploits_from_exploit_db

class PopulateExploit
  def self.populate_exploits_from_exploit_db
    csv_file_path = Rails.root.join('lib','exploit-database', 'files.csv').to_s

    ActiveRecord::Base.transaction do
      # Remove/Clean old data
      Exploit.where(source: "exploit-database").delete_all
      ExploitType.delete_all
      
      # Re Generate all Exploit data
      CSV.foreach(csv_file_path) do |row|
        unless (row[0]=='id' && row[1]=='file' && row[2]=='description')
          id = row[0]
          file = row[1]
          description = row[2]
          date = row[3]
          author = row[4]
          platform = row[5]
          exploit_type = row[6]
          port = row[7]
          
          exploit_type = ExploitType.where(title: exploit_type).first_or_create
          exploit_platform = ExploitPlatform.where(title: platform).first_or_create
          
          Exploit.create!(
            exploit_platform_id: exploit_platform.id,
            exploit_type_id: exploit_type.id,
            exploit_db_id: id,
            file: file,
            description: description,
            date: date,
            author: author,
            port: port,
            source: "exploit-database"
          )
        end
      end
    end
  end
end
